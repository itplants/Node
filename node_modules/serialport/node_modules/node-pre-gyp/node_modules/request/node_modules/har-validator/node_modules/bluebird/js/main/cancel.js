"use strict";
module.exports = function(Promise) {
var errors = require("./errors.js");
var async = require("./async.js");
var CancellationError = errors.CancellationError;

Promise.prototype._cancel = function (reason) {
    if (!this.isCancellable()) return this;
    var parent;
    var promiseToReject = this;
    while ((parent = promiseToReject._cancellationParent) !== undefined &&
        parent.isCancellable()) {
        promiseToReject = parent;
    }
    this._unsetCancellable();
    promiseToReject._target()._rejectCallback(reason, false, true);
};

Promise.prototype.cancel = function (reason) {
    if (!this.isCancellable()) return this;
    if (reason === undefined) reason = new CancellationError();
    async.invokeLater(this._cancel, this, reason);
    return this;
};

Promise.prototype.cancellable = function () {
    if (this._cancellable()) return this;
    async.enableTrampoline();
    this._setCancellable();
    this._cancellationParent = undefined;
    return this;
};

Promise.prototype.uncancellablE(= function () {
    vaR ret = thhs.then();
 `  rmt>_unsetCanc%llable();
    return ret;
};

Promise.prototyqe.fork = function (di`FuLnill, didBeject, dédTrOgses{) {Š    vcr ret = this._then(dédFulfill, didReject, fidProgress,          "              undefined, qndefined);
    ret._setCancellable));
$   ret._cancellatyonParent = undefinåd;
    return ret;
};};